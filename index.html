<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tabirly Medya Kütüphanesi</title>
  <meta name="description" content="Tabirly için blog, podcast, video ve müzik RSS/Atom/JSON feed içeriklerini tek ekranda toplayan medya kütüphanesi." />
  <style>
    :root{
      --bg:#f7f8ff; --paper:#fff; --ink:#0e1320; --muted:#5e6a86;
      --line:rgba(99,110,140,.18); --br:14px; --shadow:0 6px 20px rgba(14,19,32,.06);
      --grad:linear-gradient(90deg,#ff0080,#ff8c00,#ffd700,#00d084,#00bfff,#7b61ff,#ff0080);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
    .visually-hidden{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}
    .rainbow{background:var(--grad);background-size:300% 100%;animation:flow 12s linear infinite}
    @keyframes flow{to{background-position:300% 0}}

    #app{position:fixed;inset:0;display:flex;flex-direction:column;gap:10px;padding:12px;box-sizing:border-box}
    .top{display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:10px;border:1px solid var(--line);
         border-radius:var(--br);background:var(--paper);box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:8px;min-width:0}
    .logo{width:24px;height:24px;border-radius:7px;box-shadow:var(--shadow);background:var(--grad)}
    .title{font:800 14px/1 Inter,system-ui;white-space:nowrap}
    .grow{flex:1;min-width:160px}
    .control{display:flex;gap:6px;align-items:center}
    select,input[type="text"]{appearance:none;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#f9faff;color:var(--ink);font-weight:700}
    select{min-width:140px}
    .search{display:flex;gap:8px;align-items:center}
    .search input{width:min(420px,60vw)}
    .counts{margin-left:auto;color:var(--muted);font-size:12px}

    /* --- Daha sıkı grid (yarı boyut) --- */
    .grid{flex:1;min-height:0;display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    @media (max-width:1400px){.grid{grid-template-columns:repeat(10,1fr)}}
    @media (max-width:1024px){.grid{grid-template-columns:repeat(8,1fr)}}
    @media (max-width:820px){.grid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}

    .card{
      grid-column:span 2; /* önce 3'tü → ~%33 küçüldü, satırda 6+ kart */
      display:flex;flex-direction:column;border:1px solid var(--line);border-radius:12px;overflow:hidden;
      background:var(--paper);box-shadow:var(--shadow)
    }
    .edge{height:3px}
    .thumb{position:relative;width:100%;aspect-ratio:16/9;background:#eef1f8;overflow:hidden}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transition:filter .2s ease}
    .thumb.fallback{background:#f6edf7}
    .thumb.fallback img{object-fit:contain;padding:16px;filter:saturate(110%)}
    .card h3{font-size:13px;margin:8px 10px 4px}
    .meta{color:var(--muted);font-size:11px;margin:0 10px 8px}

    /* Açıklamayı tamamen gizle */
    .desc{display:none}

    .actions{display:flex;gap:6px;padding:8px 10px;border-top:1px solid var(--line);margin-top:auto}
    .btn{appearance:none;border:1px solid var(--line);background:#f1f4ff;color:#192038;padding:6px 8px;border-radius:8px;font:700 11px/1 Inter;cursor:pointer}
    .btn.primary{border-color:transparent;color:#fff;background:var(--grad);background-size:300% 100%;animation:flow 12s linear infinite}

    .modal{position:fixed;inset:0;background:rgba(15,19,32,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.open{display:flex}
    .sheet{width:min(1100px,96vw);height:min(80vh,80vh);background:var(--paper);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:grid;grid-template-rows:auto 1fr;box-shadow:var(--shadow)}
    .sheet header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
    .sheet iframe,.sheet audio,.sheet video{width:100%;height:100%;border:0;background:#000}
  </style>
</head>
<body>
  <div id="app">
    <div class="top">
      <div class="brand">
        <div class="logo rainbow" aria-hidden="true"></div>
        <div class="title">Tabirly Medya Kütüphanesi</div>
      </div>
      <div class="control">
        <label class="visually-hidden" for="selKind">Kategori</label>
        <select id="selKind" title="Kategori seç (Blog/Podcast/Video/Müzik)"></select>
      </div>
      <div class="control">
        <label class="visually-hidden" for="selSource">Kaynak</label>
        <select id="selSource" title="Kaynağa göre filtrele"></select>
      </div>
      <div class="search grow">
        <input id="q" type="text" placeholder="Ara: başlık, açıklama, kaynak..." />
      </div>
      <div class="counts"><span id="feedCount">0</span> kaynak · <span id="itemCount">0</span> içerik</div>
    </div>
    <div id="grid" class="grid"></div>
  </div>

  <div id="playerModal" class="modal" role="dialog" aria-modal="true">
    <div class="sheet">
      <header>
        <div id="playerTitle">Oynatıcı</div>
        <button id="closePlayer" class="btn">Kapat ✖</button>
      </header>
      <div id="playerBody"></div>
    </div>
  </div>

  <script>
  // ===== CONFIG =====
  const LOGO_URL = 'https://metehankuzu1987-pixel.github.io/tabirly-medya-k-t-phanesi/default.png';
  const CORS = 'https://little-paper-de94.metehankuzu1987.workers.dev';

  // Feed’ler
  const FEEDS = [
    { title:'Tabirly', url:'https://tr.tabirly.com/feeds/posts/default?alt=rss', type:'blog' },
    { title:'Pazartesi Meditasyonları', url:'https://media.rss.com/pazartesimeditasyonu/feed.xml', type:'podcast' },
    { title:'Miboso x Dr. Neslihan İskit (Rehberli Meditasyon)', url:'https://media.rss.com/mibosowellbeing/feed.xml', type:'podcast' },
    { title:'Yoga Nidra Podcast', url:'https://anchor.fm/s/d3781a94/podcast/rss', type:'podcast' }
  ];

  const TYPES = [
    {key:'all', label:'Hepsi'},
    {key:'blog', label:'Blog'},
    {key:'podcast', label:'Podcast'},
    {key:'video', label:'Video'},
    {key:'music', label:'Müzik'}
  ];

  // ===== STATE/REFS =====
  const $=(s,r=document)=>r.querySelector(s);
  const grid=$('#grid'), q=$('#q'), playerModal=$('#playerModal'),
        playerBody=$('#playerBody'), playerTitle=$('#playerTitle'),
        selKind=$('#selKind'), selSource=$('#selSource');
  let state={items:[],feeds:FEEDS,kind:'all',source:'all',q:''};

  function setCounts(){ $('#feedCount').textContent=state.feeds.length; $('#itemCount').textContent=state.items.length; }
  const humanDate=d=>{ try{return new Date(d).toLocaleString('tr-TR')}catch(e){return''} };
  function strip(html){ if(!html) return ''; const t=document.createElement('div'); t.innerHTML=html; return (t.textContent||'').trim().slice(0,240); }

  function buildSelectors(){
    selKind.innerHTML = TYPES.map(t=>`<option value="${t.key}">${t.label}</option>`).join('');
    selKind.value = state.kind;
    const options = ['<option value="all">Tüm kaynaklar</option>'].concat(
      state.feeds.map((f,i)=>`<option value="${i}">${f.title||('Kaynak '+(i+1))}</option>`)
    );
    selSource.innerHTML = options.join(''); selSource.value = state.source;
  }

  function cardHTML(it){
    const hasImg = Boolean(it.image);
    const imgSrc = hasImg ? it.image : LOGO_URL;
    const date = it.date ? humanDate(it.date) : '';
    const safeTitle=(it.title||'İçerik').replace(/"/g,'&quot;');

    return `<article class="card" data-id="${it._id}" data-kind="${it.kind}">
      <div class="edge rainbow" aria-hidden="true"></div>
      <div class="thumb ${hasImg ? '' : 'fallback'}">
        <img src="${imgSrc}" alt="${safeTitle}" loading="lazy"
             onerror="this.src='${LOGO_URL}'; this.closest('.thumb').classList.add('fallback');">
      </div>
      <h3 title="${safeTitle}">${it.title||'Başlıksız'}</h3>
      <div class="meta">${it.kind.toUpperCase()} • ${it.source||''} • ${date}</div>
      <!-- Açıklama kaldırıldı -->
      <div class="actions">
        <button class="btn primary play">▶ Oynat / Aç</button>
        <a class="btn" href="${it.link||'#'}" target="_blank" rel="noopener">Bağlantı</a>
      </div>
    </article>`;
  }

  function filteredItems(){
    const qv = state.q.toLowerCase();
    return state.items.filter(it=>{
      if(state.kind!=='all' && it.kind!==state.kind) return false;
      if(state.source!=='all' && it._sourceIndex!==Number(state.source)) return false;
      if(!qv) return true;
      return [it.title,it.summary,it.source].filter(Boolean).join(' ').toLowerCase().includes(qv);
    });
  }

  function render(){
    const list = filteredItems();
    grid.innerHTML = list.map(cardHTML).join('');
    setCounts();
  }

  function openPlayer(it){
    playerTitle.textContent = it.title || 'Oynatıcı';
    playerBody.innerHTML = '';
    if(it.audio){
      const a=document.createElement('audio'); a.controls=true; a.src=it.audio; a.autoplay=true; playerBody.appendChild(a);
    }else if(it.videoEmbed){
      const f=document.createElement('iframe'); f.allow='autoplay; encrypted-media; picture-in-picture'; f.referrerPolicy='no-referrer-when-downgrade'; f.src=it.videoEmbed; playerBody.appendChild(f);
    }else if(it.link){
      const f=document.createElement('iframe'); f.src=it.link; playerBody.appendChild(f);
    }else{
      playerBody.innerHTML='<div style="padding:16px">Görüntülenecek medya bulunamadı.</div>';
    }
    playerModal.classList.add('open');
  }
  $('#closePlayer').onclick=()=>playerModal.classList.remove('open');

  let t; q.oninput=()=>{ clearTimeout(t); t=setTimeout(()=>{ state.q=q.value; render(); },120); };
  selKind.onchange=()=>{ state.kind=selKind.value; render(); };
  selSource.onchange=()=>{ state.source=selSource.value; render(); };

  grid.addEventListener('click',e=>{
    const card=e.target.closest('.card'); if(!card) return;
    const it = state.items.find(x=>String(x._id)===card.dataset.id);
    if(!it) return;
    if(e.target.classList.contains('play')) openPlayer(it);
  });

  // ===== FETCH/PARSE =====
  async function fetchText(url){
    const tryFetch=async(u)=>{const r=await fetch(u,{cache:'no-store'}); return {ok:r.ok, ct:r.headers.get('content-type')||'', text:await r.text()}}
    try{
      const r=await tryFetch(`${CORS}/?url=${encodeURIComponent(url)}`); if(r.ok) return r;
      return await tryFetch(url);
    }catch{ return await tryFetch(url); }
  }
  const textContent=(n,s)=>{const el=n.querySelector(s);return el?(el.textContent||'').trim():''};
  const attr=(n,s,a)=>{const el=n.querySelector(s);return el?el.getAttribute(a):''};

  function parseXML(xmlStr){
    const doc=new DOMParser().parseFromString(xmlStr,'application/xml');
    const isAtom=!!doc.querySelector('feed > entry');
    const channelTitle=textContent(doc,isAtom?'feed > title':'channel > title');

    const chanImg = attr(doc,'channel > image > url','') || textContent(doc,'channel > image > url');

    const items=Array.from(doc.querySelectorAll(isAtom?'feed > entry':'channel > item')).map(it=>{
      const title=textContent(it,'title');
      const link=isAtom?(attr(it,'link','href')||textContent(it,'link')):textContent(it,'link');
      const pub=textContent(it,isAtom?'updated':'pubDate') || textContent(it,'dc\\:date');
      const desc=textContent(it,isAtom?'summary':'description') || textContent(it,'content\\:encoded');

      // Media candidates
      const enc=it.querySelector('enclosure');
      const mediaContent=it.querySelector('media\\:content');
      const mediaThumb=it.querySelector('media\\:thumbnail');
      const itunesImg=attr(it,'itunes\\:image','href');
      const img = (mediaThumb&&mediaThumb.getAttribute('url')) ||
                  (mediaContent&&mediaContent.getAttribute('url')) ||
                  itunesImg || chanImg || '';

      let videoEmbed='';
      if(link && /youtube\.com\/watch|youtu\.be/.test(link)){
        const id=(link.match(/[?&]v=([\w-]+)/)||[])[1]||link.split('/').pop();
        videoEmbed=`https://www.youtube.com/embed/${id}`;
      }
      const audio=(enc && /audio\//.test(enc.getAttribute('type')||'')) ? enc.getAttribute('url') : '';

      return {title,link,date:pub,summary:strip(desc),image:img||'',audio,videoEmbed,source:channelTitle};
    });
    return items;
  }

  function parseJSONFeed(text){
    const j=JSON.parse(text); const title=j.title||'Kaynak';
    return (j.items||[]).map(it=>({
      title:it.title,
      link:it.url||(it.external_url||''),
      date:it.date_published||it.date_modified,
      summary:strip(it.summary||it.content_text||it.content_html||''),
      image:it.image||((it.attachments||[])[0]?.url)||'',
      audio:(it.attachments||[]).find(a=>(a.mime_type||'').startsWith('audio/'))?.url||'',
      source:title
    }));
  }

  const detectKind=(t,i)=> (t==='podcast'||i.audio)?'podcast' : (t==='music')?'music' : (t==='video'||i.videoEmbed)?'video' : 'blog';

  async function loadOne(feed,index){
    try{
      const {ct,text}=await fetchText(feed.url);
      let raw=[];
      if(/json|javascript/.test(ct)||text.trim().startsWith('{')) raw=parseJSONFeed(text); else raw=parseXML(text);
      return raw.map(it=>({...it,kind:detectKind(feed.type,it),_sourceIndex:index}));
    }catch(err){
      console.warn('Feed hatası',feed.url,err);
      return [{title:'Kaynak okunamadı',summary:'TypeError: Failed to fetch — CORS proxy gerekli olabilir.',link:feed.url,kind:'blog',source:feed.title,_sourceIndex:index}];
    }
  }

  function dedupeByLink(arr){
    const seen=new Set();
    return arr.filter(x=>{
      const k=(x.link||x.title||'') + '|' + (x.date?new Date(x.date).toISOString():'');
      if(seen.has(k)) return false; seen.add(k); return true;
    });
  }

  async function loadAll(){
    $('#itemCount').textContent='…';
    const arrays=await Promise.all(state.feeds.map((f,i)=>loadOne(f,i)));
    let items=arrays.flat().map(it=>({...it,date:it.date?new Date(it.date):null}));
    items = dedupeByLink(items).sort((a,b)=> (b.date?.getTime()||0)-(a.date?.getTime()||0));

    // id ata + görüntüsüzleri otomatik LOGO
    state.items = items.map((it,idx)=>({
      ...it,
      _id: String(idx),
      image: it.image && it.image.startsWith('http') ? it.image : '' // kötü/relative ise boş bırak
    }));
    buildSelectors(); render();
  }

  buildSelectors(); loadAll();

  // dışa aç
  window.TabirlyMedia={state,render,loadAll};
  </script>
</body>
</html>
