<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tabirly Medya K√ºt√ºphanesi</title>
  <meta name="description" content="Tabirly i√ßin blog, podcast, video ve m√ºzik RSS/Atom/JSON Feed i√ßeriklerini tek ekranda toplayan medya k√ºt√ºphanesi." />
  <style>
    :root{
      --bg:#0b0b12; --text:#e6e7ee; --muted:#a9acb8; --card:#121422; --accent:#9b87f5; --accent-2:#7dd3fc; --ok:#34d399; --warn:#fbbf24;
      --br:18px; --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    html,body{height:100%;margin:0;background:radial-gradient(1000px 800px at 20% -10%, rgba(255,229,246,.12) 0%, rgba(255,229,246,0) 55%),
                                      radial-gradient(900px 600px at 100% 0%, rgba(125,211,252,.12) 0%, rgba(125,211,252,0) 45%),
                                      var(--bg);
               color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    #app{position:fixed;inset:0;display:grid;grid-template-columns:280px 1fr;gap:14px;padding:14px;box-sizing:border-box}
    @media (max-width:900px){#app{grid-template-columns:1fr}}  
    .sidebar{background:rgba(255,255,255,.03);backdrop-filter:saturate(140%) blur(8px);border:1px solid rgba(255,255,255,.07);border-radius:var(--br);padding:14px;overflow:auto}
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:14px}
    .logo{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:var(--shadow)}
    .brand h1{font-size:16px;margin:0}
    .filters{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 14px}
    .chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.1);cursor:pointer;user-select:none}
    .chip.active{background:linear-gradient(135deg,rgba(155,135,245,.18),rgba(125,211,252,.18));border-color:transparent}
    .stat{font-size:12px;color:var(--muted)}

    .content{min-width:0;display:flex;flex-direction:column;gap:12px}
    .topbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .search{flex:1;display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
    .search input{all:unset;flex:1}
    .btn{all:unset;background:linear-gradient(135deg,rgba(155,135,245,.25),rgba(125,211,252,.25));border:1px solid rgba(255,255,255,.1);padding:10px 12px;border-radius:12px;cursor:pointer}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    @media (max-width:1400px){.grid{grid-template-columns:repeat(8,1fr)}}
    @media (max-width:900px){.grid{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:600px){.grid{grid-template-columns:repeat(2,1fr)}}

    .card{grid-column:span 3;background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--br);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .card .thumb{aspect-ratio:16/9;background:#1b1d2d;display:flex;align-items:center;justify-content:center;color:#7f86a5;font-size:12px}
    .card h3{font-size:15px;margin:10px 12px 6px}
    .card .meta{color:var(--muted);font-size:12px;margin:0 12px 10px}
    .card .desc{color:#cfd2dc;font-size:13px;margin:0 12px 12px}
    .card .actions{display:flex;gap:8px;padding:10px 12px;border-top:1px solid rgba(255,255,255,.06);margin-top:auto}
    .tag{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.08)}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.open{display:flex}
    .sheet{width:min(1100px,96vw);height:min(70vh,80vh);background:#0d0f19;border:1px solid rgba(255,255,255,.08);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;display:grid;grid-template-rows:auto 1fr}
    .sheet header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.07)}
    .sheet iframe,.sheet audio,.sheet video{width:100%;height:100%;background:#000;border:0}

    .footer{color:var(--muted);font-size:12px;padding:6px 2px}
    a{color:#b9d6ff}
  </style>
</head>
<body>
  <div id="app">
    <aside class="sidebar">
      <div class="brand">
        <div class="logo"></div>
        <h1>Tabirly Medya K√ºt√ºphanesi</h1>
      </div>
      <div class="stat"><span id="feedCount">0</span> kaynak / <span id="itemCount">0</span> i√ßerik</div>
      <div class="filters" id="filters"></div>
      <details open>
        <summary>Kaynaklar (RSS/Atom/JSON)</summary>
        <div id="feedList" style="margin-top:8px;display:grid;gap:8px"></div>
      </details>
      <div class="footer">Made for <strong>Tabirly</strong>. GH Pages + iFrame embed. ‚úîÔ∏è</div>
    </aside>

    <main class="content">
      <div class="topbar">
        <div class="search"><span>üîé</span><input id="q" placeholder="Ara: ba≈ülƒ±k, a√ßƒ±klama, kaynak..." /></div>
        <button class="btn" id="refreshBtn">‚Üª Yenile</button>
        <button class="btn" id="homeBtn" title="Ana sayfa">üè† Ana sayfa</button>
      </div>
      <div class="grid" id="grid"></div>
    </main>
  </div>

  <!-- Modal Player -->
  <div class="modal" id="playerModal" role="dialog" aria-modal="true">
    <div class="sheet">
      <header>
        <div id="playerTitle">Oynatƒ±cƒ±</div>
        <button class="btn" id="closePlayer">Kapat ‚úñ</button>
      </header>
      <div id="playerBody"></div>
    </div>
  </div>

  <script>
  // ================== CONFIG ==================
  // CORS proxy: Kendi Cloudflare Worker URL'inizi yazƒ±n (a≈üaƒüƒ±da worker kodu var).
  const CORS = localStorage.getItem('tabirly_cors') || 'https://r.tabirly.workers.dev';

  // Varsayƒ±lan √∂rnek feed'ler (dilediƒüin gibi deƒüi≈ütir):
  const FEEDS = [
    { title:'Tabirly Blog (JSON Feed √∂r.)', url:'https://jsonfeed.org/feed.json', type:'blog' },
    { title:'NPR - Planet Money (Podcast RSS)', url:'https://feeds.npr.org/510289/podcast.xml', type:'podcast' },
    { title:'The Verge (Atom)', url:'https://www.theverge.com/rss/index.xml', type:'blog' },
    { title:'Synthwave FM (M√ºzik Podcast)', url:'https://feeds.simplecast.com/dLRotFG5', type:'music' }
    // YouTube i√ßin: https://www.youtube.com/feeds/videos.xml?channel_id=...
  ];

  const TYPES = [
    {key:'all', label:'Hepsi'},
    {key:'blog', label:'Blog'},
    {key:'podcast', label:'Podcast'},
    {key:'video', label:'Video'},
    {key:'music', label:'M√ºzik'}
  ];

  // ================== STATE ==================
  let state = { items:[], filter:'all', q:'', feeds:FEEDS };

  // ================== INIT ==================
  const $ = (s,root=document)=>root.querySelector(s);
  const $$ = (s,root=document)=>Array.from(root.querySelectorAll(s));

  const grid = $('#grid');
  const feedList = $('#feedList');
  const filters = $('#filters');
  const q = $('#q');
  const playerModal = $('#playerModal');
  const playerBody = $('#playerBody');
  const playerTitle = $('#playerTitle');

  function saveFeeds(){ localStorage.setItem('tabirly_feeds', JSON.stringify(state.feeds)); }
  function loadFeeds(){ const raw = localStorage.getItem('tabirly_feeds'); if(raw){ try{ state.feeds = JSON.parse(raw);}catch(e){} } }

  function humanDate(d){ try{ return new Date(d).toLocaleString('tr-TR'); }catch(e){ return ''} }

  function setCounts(){
    $('#feedCount').textContent = state.feeds.length;
    $('#itemCount').textContent = state.items.length;
  }

  function renderFilters(){
    filters.innerHTML = TYPES.map(t=>`<span class="chip ${state.filter===t.key?'active':''}" data-key="${t.key}">${t.label}</span>`).join('');
    $$('.chip', filters).forEach(el=> el.onclick = ()=>{ state.filter = el.dataset.key; render(); });
  }

  function renderFeeds(){
    feedList.innerHTML = '';
    state.feeds.forEach((f,i)=>{
      const row = document.createElement('div');
      row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto'; row.style.gap='6px'; row.style.alignItems='center';
      row.innerHTML = `
        <div style="font-size:13px;line-height:1.2">
          <div><strong>${f.title||'Kaynak'}</strong></div>
          <div style="color:var(--muted);word-break:break-all">${f.url}</div>
        </div>
        <select data-i="${i}" class="typeSel" style="background:#0d0f19;color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:6px">
          <option value="blog" ${f.type==='blog'?'selected':''}>Blog</option>
          <option value="podcast" ${f.type==='podcast'?'selected':''}>Podcast</option>
          <option value="video" ${f.type==='video'?'selected':''}>Video</option>
          <option value="music" ${f.type==='music'?'selected':''}>M√ºzik</option>
        </select>
        <button class="btn del" data-i="${i}">Sil</button>`;
      feedList.appendChild(row);
    });
    // Add new
    const add = document.createElement('div');
    add.style.marginTop='8px';
    add.innerHTML = `
      <input id="newTitle" placeholder="Ba≈ülƒ±k" style="width:100%;margin-bottom:6px;background:#0d0f19;color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:8px"/>
      <input id="newUrl" placeholder="Feed URL (RSS/Atom/JSON)" style="width:100%;margin-bottom:6px;background:#0d0f19;color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:8px"/>
      <select id="newType" style="width:100%;margin-bottom:6px;background:#0d0f19;color:var(--text);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:8px">
        <option value="blog">Blog</option>
        <option value="podcast">Podcast</option>
        <option value="video">Video</option>
        <option value="music">M√ºzik</option>
      </select>
      <button class="btn" id="addFeedBtn">+ Kaynak Ekle</button>
      <div class="stat" style="margin-top:6px">CORS proxy: <code>${CORS}</code></div>
    `;
    feedList.appendChild(add);

    feedList.onclick = (e)=>{
      if(e.target.classList.contains('del')){
        const i = +e.target.dataset.i; state.feeds.splice(i,1); saveFeeds(); renderFeeds();
      }
    }
    $$('.typeSel', feedList).forEach(sel=> sel.onchange = (e)=>{
      const i = +sel.dataset.i; state.feeds[i].type = sel.value; saveFeeds();
    });
    $('#addFeedBtn')?.addEventListener('click', ()=>{
      const t = $('#newTitle').value.trim();
      const u = $('#newUrl').value.trim();
      const ty = $('#newType').value;
      if(!u) return alert('Feed URL gir');
      state.feeds.push({title:t||u,type:ty,url:u}); saveFeeds(); renderFeeds();
    });
  }

  function cardHTML(it){
    const img = it.image || it.thumbnail || '';
    const thumb = img ? `<img src="${img}" alt="${(it.title||'ƒ∞√ßerik').replace(/"/g,'&quot;')}" class="thumb" style="width:100%;height:auto;aspect-ratio:16/9;object-fit:cover">`
                       : `<div class="thumb">√ñnizleme yok</div>`;
    const tag = `<span class="tag">${it.kind||'ƒ∞√ßerik'}</span>`;
    const date = it.date ? humanDate(it.date) : '';
    return `<article class="card" data-kind="${it.kind}" data-src="${it.src||''}">
      ${thumb}
      <h3 title="${(it.title||'').replace(/"/g,'&quot;')}">${it.title||'Ba≈ülƒ±ksƒ±z'}</h3>
      <div class="meta">${tag} ‚Ä¢ ${it.source||''} ‚Ä¢ ${date}</div>
      <p class="desc">${it.summary||''}</p>
      <div class="actions">
        <button class="btn play">‚ñ∂ Oynat / A√ß</button>
        <a class="btn" href="${it.link||'#'}" target="_blank" rel="noopener">Baƒülantƒ±</a>
      </div>
    </article>`
  }

  function render(){
    const qv = state.q.toLowerCase();
    const filtered = state.items.filter(it=>{
      if(state.filter!=='all' && it.kind!==state.filter) return false;
      if(!qv) return true;
      return [it.title, it.summary, it.source].filter(Boolean).join(' ').toLowerCase().includes(qv);
    });
    grid.innerHTML = filtered.map(cardHTML).join('');
    setCounts();
  }

  function openPlayer(it){
    playerTitle.textContent = it.title || 'Oynatƒ±cƒ±';
    playerBody.innerHTML = '';

    // Kaynaƒüa g√∂re g√∂mme: 
    if(it.audio){
      const audio = document.createElement('audio');
      audio.controls = true; audio.src = it.audio; audio.autoplay = true;
      playerBody.appendChild(audio);
    } else if(it.videoEmbed){
      const iframe = document.createElement('iframe');
      iframe.allow = 'autoplay; encrypted-media; picture-in-picture';
      iframe.referrerPolicy = 'no-referrer-when-downgrade';
      iframe.src = it.videoEmbed; playerBody.appendChild(iframe);
    } else if(it.link){
      const iframe = document.createElement('iframe');
      iframe.src = it.link; playerBody.appendChild(iframe);
    } else {
      playerBody.innerHTML = '<div style="padding:20px">G√∂r√ºnt√ºlenecek medya bulunamadƒ±.</div>'
    }
    playerModal.classList.add('open');
  }

  $('#closePlayer').onclick = ()=> playerModal.classList.remove('open');
  $('#refreshBtn').onclick = ()=> loadAll();
  $('#homeBtn').onclick = ()=> { window.top ? window.top.location.href='/' : location.href='/'; };

  q.oninput = (e)=>{ state.q = q.value; render(); };
  grid.addEventListener('click', (e)=>{
    const card = e.target.closest('.card');
    if(!card) return;
    const idx = Array.from(grid.children).indexOf(card);
    const filtered = state.items.filter(it=> (state.filter==='all'||it.kind===state.filter) &&
      (!state.q || [it.title,it.summary,it.source].filter(Boolean).join(' ').toLowerCase().includes(state.q.toLowerCase())));
    const it = filtered[idx];
    if(e.target.classList.contains('play')) openPlayer(it);
  });

  // ================== FEED FETCH/PARSE ==================
  async function fetchText(url){
    const prox = `${CORS}/?url=${encodeURIComponent(url)}`;
    const r = await fetch(prox); if(!r.ok) throw new Error('Fetch hata');
    const ct = r.headers.get('content-type')||''; const text = await r.text();
    return {ct,text};
  }

  function pick(obj,keys){ const out={}; keys.forEach(k=> out[k]=obj[k]); return out; }

  function textContent(node,sel){ const el = node.querySelector(sel); return el? (el.textContent||'').trim():''; }
  function attr(node,sel,attr){ const el = node.querySelector(sel); return el? el.getAttribute(attr):''; }

  function parseXML(xmlStr){
    const doc = new DOMParser().parseFromString(xmlStr,'application/xml');
    // RSS 2.0 or Atom
    const isAtom = !!doc.querySelector('feed > entry');
    const channelTitle = textContent(doc, isAtom? 'feed > title' : 'channel > title');
    const items = Array.from(doc.querySelectorAll(isAtom? 'feed > entry' : 'channel > item')).map(it=>{
      const title = textContent(it, isAtom? 'title' : 'title');
      const link = isAtom? (attr(it,'link','href')|| textContent(it,'link')) : textContent(it,'link');
      const pub = textContent(it, isAtom? 'updated' : 'pubDate');
      const desc = textContent(it, isAtom? 'summary' : 'description');
      const enc = it.querySelector('enclosure');
      const mediaContent = it.querySelector('media\\:content');
      const mediaThumb = it.querySelector('media\\:thumbnail');
      const enclosureUrl = enc? enc.getAttribute('url'):'';
      const mediaUrl = mediaContent? mediaContent.getAttribute('url'):'';
      const thumbUrl = mediaThumb? mediaThumb.getAttribute('url'):'';
      const img = thumbUrl || mediaUrl || attr(it,'content','url') || '';

      // YouTube Atom embed
      let videoEmbed = '';
      if(link && /youtube.com\/watch|youtu.be/.test(link)){
        const id = (link.match(/[?&]v=([\w-]+)/)||[])[1] || link.split('/').pop();
        videoEmbed = `https://www.youtube.com/embed/${id}`;
      }

      // Podcast: prefer enclosure audio
      const audio = (enc && /audio\//.test(enc.getAttribute('type')||'')) ? enclosureUrl : '';

      return {
        title, link, date:pub, summary:strip(desc), image:img, audio, videoEmbed,
        source:channelTitle
      }
    });
    return items;
  }

  function strip(html){
    if(!html) return '';
    const tmp = document.createElement('div'); tmp.innerHTML = html; return tmp.textContent.trim().slice(0,240);
  }

  function parseJSONFeed(text){
    const j = JSON.parse(text);
    const title = j.title || 'Kaynak';
    return (j.items||[]).map(it=>({
      title: it.title,
      link: it.url || (it.external_url||''),
      date: it.date_published || it.date_modified,
      summary: strip(it.summary || it.content_text || it.content_html||''),
      image: it.image || (it.attachments&&it.attachments[0]?.url) || '',
      audio: (it.attachments||[]).find(a=> (a.mime_type||'').startsWith('audio/'))?.url || '',
      source: title
    }));
  }

  function detectKind(feedType, item){
    if(feedType==='podcast' || item.audio) return 'podcast';
    if(feedType==='music') return 'music';
    if(feedType==='video' || item.videoEmbed) return 'video';
    return 'blog';
  }

  async function loadOne(feed){
    try{
      const {ct,text} = await fetchText(feed.url);
      let rawItems = [];
      if(/json|javascript/.test(ct) || text.trim().startsWith('{')) rawItems = parseJSONFeed(text);
      else rawItems = parseXML(text);
      // Map + kind
      return rawItems.map(it=> ({...it, kind: detectKind(feed.type, it)}));
    }catch(err){
      console.warn('Feed hatasƒ±', feed.url, err);
      return [{ title: `Kaynak okunamadƒ±`, summary: String(err), link: feed.url, kind:'blog', source: feed.title }];
    }
  }

  async function loadAll(){
    $('#itemCount').textContent = '‚Ä¶';
    const arrays = await Promise.all(state.feeds.map(loadOne));
    // Flatten + sort by date desc
    const list = arrays.flat().map(it=> ({...it, date: it.date? new Date(it.date): null}))
      .sort((a,b)=> (b.date?.getTime()||0) - (a.date?.getTime()||0));
    state.items = list;
    render();
  }

  // Boot
  loadFeeds();
  renderFilters();
  renderFeeds();
  loadAll();

  // Expose for console tweaking
  window.TabirlyMedia = { state, render, loadAll };
  </script>

  <!-- ================== OPTIONAL: Cloudflare Worker (CORS Proxy) ==================
Deploy et ve yukarƒ±daki CORS deƒüi≈ükenine Worker URL'ini yaz.

export default {
  async fetch(req){
    const u = new URL(req.url);
    const target = u.searchParams.get('url');
    if(!target) return new Response('Missing ?url', {status:400});
    const r = await fetch(target, { headers: { 'user-agent': req.headers.get('user-agent')||'TabirlyBot/1.0' }});
    const h = new Headers(r.headers);
    h.set('access-control-allow-origin','*');
    h.set('access-control-allow-headers','*');
    return new Response(await r.text(), {status:r.status, headers:h});
  }
}
  ================== END WORKER ================== -->
</body>
</html>
