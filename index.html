<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tabirly Medya KÃ¼tÃ¼phanesi</title>
  <meta name="description" content="Tabirly iÃ§in blog, podcast, video ve mÃ¼zik RSS/Atom/JSON feed iÃ§eriklerini tek ekranda toplayan medya kÃ¼tÃ¼phanesi." />
  <style>
    :root{
      --bg:#f7f8ff; --paper:#fff; --ink:#0e1320; --muted:#5e6a86;
      --line:rgba(99,110,140,.18); --br:14px; --shadow:0 6px 20px rgba(14,19,32,.06);
      --grad:linear-gradient(90deg,#ff0080,#ff8c00,#ffd700,#00d084,#00bfff,#7b61ff,#ff0080);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
    .sr-only{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}

    /* Uygulama iskeleti */
    #app{position:fixed;inset:0;display:flex;flex-direction:column;gap:12px;padding:12px}
    .top{display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:10px;border:1px solid var(--line);
         border-radius:var(--br);background:var(--paper);box-shadow:var(--shadow)}
    .brand{display:flex;align-items:center;gap:8px;min-width:0}
    .logo{width:24px;height:24px;border-radius:7px;background:var(--grad)}
    .title{font:800 14px/1 Inter,system-ui;white-space:nowrap}
    .grow{flex:1;min-width:160px}
    .ctl{display:flex;gap:6px;align-items:center}
    select,input[type="text"]{appearance:none;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#f9faff;color:var(--ink);font-weight:700}
    select{min-width:140px}
    .search{display:flex;gap:8px;align-items:center}
    .search input{width:min(420px,60vw)}
    .counts{margin-left:auto;color:var(--muted);font-size:12px}

    /* GRID â€” her koÅŸulda saÄŸlam */
    .grid{flex:1;min-height:0;overflow:auto;scroll-behavior:smooth;
      display:grid;gap:12px;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); /* sabit ve esnek */
      align-content:start}
    .card{
      display:flex;flex-direction:column;border:1px solid var(--line);
      border-radius:12px;overflow:hidden;background:var(--paper);box-shadow:var(--shadow)
    }
    .thumb{position:relative;width:100%;aspect-ratio:16/9;background:#eef1f8;overflow:hidden}
    .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .thumb.fallback{background:#f6edf7}
    .thumb.fallback img{object-fit:contain;padding:14px}

    .body{display:flex;flex-direction:column;gap:6px;padding:10px 12px 8px;min-height:88px;flex:1}
    .card h3{font-size:14px;font-weight:800;margin:0;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .meta{color:var(--muted);font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .actions{display:flex;gap:6px;padding:10px 12px;border-top:1px solid var(--line)}
    .btn{appearance:none;border:1px solid var(--line);background:#f1f4ff;color:#192038;padding:6px 8px;border-radius:8px;font:700 11px/1 Inter;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
    .btn.primary{border-color:transparent;color:#fff;background:var(--grad)}

    /* Modal oynatÄ±cÄ± */
    .modal{position:fixed;inset:0;background:rgba(15,19,32,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.open{display:flex}
    .sheet{width:min(1100px,96vw);height:min(80vh,80vh);background:var(--paper);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:grid;grid-template-rows:auto 1fr;box-shadow:var(--shadow)}
    .sheet header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
    .sheet iframe,.sheet audio,.sheet video{width:100%;height:100%;border:0;background:#000}

    /* Sonsuz akÄ±ÅŸ sentinel */
    .sentinel{height:1px}
  </style>
</head>
<body>
  <div id="app">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">Tabirly Medya KÃ¼tÃ¼phanesi</div>
      </div>
      <div class="ctl">
        <label class="sr-only" for="kind">Kategori</label>
        <select id="kind" title="Kategori seÃ§ (Blog/Podcast/Video/MÃ¼zik)"></select>
      </div>
      <div class="ctl">
        <label class="sr-only" for="source">Kaynak</label>
        <select id="source" title="KaynaÄŸa gÃ¶re filtrele"></select>
      </div>
      <div class="search grow">
        <input id="q" type="text" placeholder="Ara: baÅŸlÄ±k, kaynak..." />
      </div>
      <div class="counts"><span id="feedCount">0</span> kaynak Â· <span id="shownCount">0</span>/<span id="totalCount">0</span> iÃ§erik</div>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>
    <div id="sentinel" class="sentinel"></div>
  </div>

  <div id="playerModal" class="modal" role="dialog" aria-modal="true">
    <div class="sheet">
      <header>
        <div id="playerTitle">OynatÄ±cÄ±</div>
        <button id="closePlayer" class="btn">Kapat âœ–</button>
      </header>
      <div id="playerBody"></div>
    </div>
  </div>

  <script>
  /* ===== CONFIG ===== */
  const LOGO_URL = 'https://metehankuzu1987-pixel.github.io/tabirly-medya-k-t-phanesi/default.png';

  const CORS = 'https://little-paper-de94.metehankuzu1987.workers.dev';

  const FEEDS = [
    { title:'Tabirly', url:'https://tr.tabirly.com/feeds/posts/default?alt=rss', type:'blog' },
    { title:'Pazartesi MeditasyonlarÄ±', url:'https://media.rss.com/pazartesimeditasyonu/feed.xml', type:'podcast' },
    { title:'Miboso x Dr. Neslihan Ä°skit (Rehberli Meditasyon)', url:'https://media.rss.com/mibosowellbeing/feed.xml', type:'podcast' },
    { title:'Yoga Nidra Podcast', url:'https://anchor.fm/s/d3781a94/podcast/rss', type:'podcast' }
  ];

  const TYPES = [
    {key:'all', label:'Hepsi'},
    {key:'blog', label:'Blog'},
    {key:'podcast', label:'Podcast'},
    {key:'video', label:'Video'},
    {key:'music', label:'MÃ¼zik'}
  ];

  /* ===== STATE / REFS ===== */
  const $=(s,r=document)=>r.querySelector(s);
  const grid=$('#grid'), q=$('#q'), playerModal=$('#playerModal'),
        playerBody=$('#playerBody'), playerTitle=$('#playerTitle'),
        selKind=$('#kind'), selSource=$('#source'),
        sentinel=$('#sentinel');
  let state={
    items:[], feeds:FEEDS, kind:'all', source:'all', q:'',
    filtered:[], shown:0, pageSize:24
  };

  const setCounts=()=>{
    $('#feedCount').textContent=state.feeds.length;
    $('#totalCount').textContent=state.filtered.length;
    $('#shownCount').textContent=state.shown;
  };
  const humanDate=d=>{ try{return d?new Date(d).toLocaleDateString('tr-TR'):""}catch(e){return''} };
  const strip=html=>{
    if(!html) return '';
    const t=document.createElement('div'); t.innerHTML=html;
    // sadece metin; kartta aÃ§Ä±klama gÃ¶stermiyoruz.
    return (t.textContent||'').trim();
  };

  function buildSelectors(){
    selKind.innerHTML = TYPES.map(t=>`<option value="${t.key}">${t.label}</option>`).join('');
    selKind.value = state.kind;
    const options = ['<option value="all">TÃ¼m kaynaklar</option>'].concat(
      state.feeds.map((f,i)=>`<option value="${i}">${f.title||('Kaynak '+(i+1))}</option>`)
    );
    selSource.innerHTML = options.join(''); selSource.value = state.source;
  }

  const primaryLabel=(it)=>{
    if(it.kind==='podcast' || it.kind==='music') return 'â–¶ Dinle';
    if(it.kind==='video') return 'â–¶ Ä°zle';
    return 'ðŸ“– Oku';
  };

  function cardHTML(it){
    const hasImg = Boolean(it.image);
    const imgSrc = hasImg ? it.image : LOGO_URL;
    const safeTitle=(it.title||'Ä°Ã§erik').replace(/"/g,'&quot;');
    return `<article class="card" data-id="${it._id}" data-kind="${it.kind}">
      <div class="thumb ${hasImg ? '' : 'fallback'}">
        <img src="${imgSrc}" alt="${safeTitle}" loading="lazy"
             onerror="this.src='${LOGO_URL}'; this.closest('.thumb').classList.add('fallback');">
      </div>
      <div class="body">
        <h3 title="${safeTitle}">${it.title||'BaÅŸlÄ±ksÄ±z'}</h3>
        <div class="meta">${it.source||''}${it.date?` Â· ${humanDate(it.date)}`:''}</div>
      </div>
      <div class="actions">
        <button class="btn primary play">${primaryLabel(it)}</button>
        <a href="${it.link}" target="_blank" class="btn">BaÄŸlantÄ±</a>
      </div>
    </article>`;
  }

  function filteredItems(){
    const qv = state.q.toLowerCase();
    return state.items.filter(it=>{
      if(state.kind!=='all' && it.kind!==state.kind) return false;
      if(state.source!=='all' && it._sourceIndex!==Number(state.source)) return false;
      if(!qv) return true;
      return [it.title,it.source].filter(Boolean).join(' ').toLowerCase().includes(qv);
    });
  }

  function resetAndRender(){
    state.filtered = filteredItems();
    state.shown = 0;
    grid.innerHTML = '';
    renderNext(true);
  }

  function renderNext(initial=false){
    const start = state.shown;
    const end = Math.min(state.shown + state.pageSize, state.filtered.length);
    const slice = state.filtered.slice(start,end);
    const frag = document.createDocumentFragment();
    const div = document.createElement('div');
    div.innerHTML = slice.map(cardHTML).join('');
    while(div.firstChild) frag.appendChild(div.firstChild);
    grid.appendChild(frag);
    state.shown = end;
    setCounts();
    if(initial) window.scrollTo({top:0,behavior:'instant'});
  }

  function openPlayer(it){
    playerTitle.textContent = it.title || 'OynatÄ±cÄ±';
    playerBody.innerHTML = '';
    if(it.audio){
      const a=document.createElement('audio'); a.controls=true; a.src=it.audio; a.autoplay=true; playerBody.appendChild(a);
    }else if(it.videoEmbed){
      const f=document.createElement('iframe'); f.allow='autoplay; encrypted-media; picture-in-picture'; f.referrerPolicy='no-referrer-when-downgrade'; f.src=it.videoEmbed; playerBody.appendChild(f);
    }else if(it.link){
      window.open(it.link,'_blank'); return; // blog ise yeni sekme
    }else{
      playerBody.innerHTML='<div style="padding:16px">GÃ¶rÃ¼ntÃ¼lenecek medya bulunamadÄ±.</div>';
    }
    playerModal.classList.add('open');
  }
  $('#closePlayer').onclick=()=>playerModal.classList.remove('open');

  let t; q.oninput=()=>{ clearTimeout(t); t=setTimeout(()=>{ state.q=q.value; resetAndRender(); },150); };
  selKind.onchange=()=>{ state.kind=selKind.value; resetAndRender(); };
  selSource.onchange=()=>{ state.source=selSource.value; resetAndRender(); };

  grid.addEventListener('click',e=>{
    const card=e.target.closest('.card'); if(!card) return;
    const it = state.filtered[Number(card.dataset.id)] || state.items.find(x=>String(x._id)===card.dataset.id);
    if(!it) return;
    if(e.target.classList.contains('play')) openPlayer(it);
  });

  /* ===== FETCH/PARSE ===== */
  async function fetchText(url){
    const tryFetch=async(u)=>{const r=await fetch(u,{cache:'no-store'}); return {ok:r.ok, ct:r.headers.get('content-type')||'', text:await r.text()}}
    try{
      const r=await tryFetch(`${CORS}/?url=${encodeURIComponent(url)}`); if(r.ok) return r;
      return await tryFetch(url);
    }catch{ return await tryFetch(url); }
  }
  const textContent=(n,s)=>{const el=n.querySelector(s);return el?(el.textContent||'').trim():''};
  const attr=(n,s,a)=>{const el=n.querySelector(s);return el?el.getAttribute(a):''};

  const firstImgFromHTML = (html) => {
    if(!html) return '';
    const t=document.createElement('div'); t.innerHTML=html;
    const img=t.querySelector('img[src]');
    const src=img?.getAttribute('src')||'';
    return /^https?:/i.test(src) ? src : '';
  };

  function parseXML(xmlStr){
    const doc=new DOMParser().parseFromString(xmlStr,'application/xml');
    const isAtom=!!doc.querySelector('feed > entry');
    const channelTitle=textContent(doc,isAtom?'feed > title':'channel > title');
    const chanImg = attr(doc,'channel > image > url','') || textContent(doc,'channel > image > url');

    const items=Array.from(doc.querySelectorAll(isAtom?'feed > entry':'channel > item')).map(it=>{
      const title=textContent(it,'title');
      const link=isAtom?(attr(it,'link','href')||textContent(it,'link')):textContent(it,'link');
      const pub=textContent(it,isAtom?'updated':'pubDate') || textContent(it,'dc\\:date');
      const descRaw=textContent(it,isAtom?'summary':'description') || textContent(it,'content\\:encoded');
      const desc=strip(descRaw);

      const enc=it.querySelector('enclosure');
      const mediaContent=it.querySelector('media\\:content');
      const mediaThumb=it.querySelector('media\\:thumbnail');
      const itunesImg=attr(it,'itunes\\:image','href');
      let img = (mediaThumb&&mediaThumb.getAttribute('url')) ||
                (mediaContent&&mediaContent.getAttribute('url')) ||
                itunesImg || firstImgFromHTML(descRaw) || chanImg || '';

      let videoEmbed='';
      if(link && /youtube\.com\/watch|youtu\.be/.test(link)){
        const id=(link.match(/[?&]v=([\w-]+)/)||[])[1]||link.split('/').pop();
        videoEmbed=`https://www.youtube.com/embed/${id}`;
      }
      const audio=(enc && /audio\//.test(enc.getAttribute('type')||'')) ? enc.getAttribute('url') : '';

      return {title,link,date:pub,summary:desc,image:img||'',audio,videoEmbed,source:channelTitle};
    });
    return items;
  }

  function parseJSONFeed(text){
    const j=JSON.parse(text); const title=j.title||'Kaynak';
    return (j.items||[]).map(it=>({
      title:it.title,
      link:it.url||(it.external_url||''),
      date:it.date_published||it.date_modified,
      summary:strip(it.summary||it.content_text||it.content_html||''),
      image:it.image||((it.attachments||[])[0]?.url)||firstImgFromHTML(it.content_html)||'',
      audio:(it.attachments||[]).find(a=>(a.mime_type||'').startsWith('audio/'))?.url||'',
      source:title
    }));
  }

  const detectKind=(t,i)=> (t==='podcast'||i.audio)?'podcast' : (t==='music')?'music' : (t==='video'||i.videoEmbed)?'video' : 'blog';

  async function loadOne(feed,index){
    try{
      const {ct,text}=await fetchText(feed.url);
      let raw=[];
      if(/json|javascript/.test(ct)||text.trim().startsWith('{')) raw=parseJSONFeed(text); else raw=parseXML(text);
      return raw.map(it=>({...it,kind:detectKind(feed.type,it),_sourceIndex:index}));
    }catch(err){
      console.warn('Feed hatasÄ±',feed.url,err);
      return [{title:'Kaynak okunamadÄ±',summary:'TypeError: Failed to fetch â€” CORS proxy gerekli olabilir.',link:feed.url,kind:'blog',source:feed.title,_sourceIndex:index}];
    }
  }

  function dedupeByLink(arr){
    const seen=new Set();
    return arr.filter(x=>{
      const k=(x.link||x.title||'') + '|' + (x.date?new Date(x.date).toISOString():'');
      if(seen.has(k)) return false; seen.add(k); return true;
    });
  }

  async function loadAll(){
    $('#totalCount').textContent='â€¦';
    const arrays=await Promise.all(state.feeds.map((f,i)=>loadOne(f,i)));
    let items=arrays.flat().map(it=>({...it,date:it.date?new Date(it.date):null}));
    items = dedupeByLink(items).sort((a,b)=> (b.date?.getTime()||0)-(a.date?.getTime()||0));

    state.items = items.map((it,idx)=>({
      ...it,
      _id: String(idx),
      image: (it.image && /^https?:/i.test(it.image)) ? it.image : '' // bozuk/relative ise logo dÃ¼ÅŸer
    }));
    buildSelectors();
    state.filtered = filteredItems();
    resetAndRender();
  }

  /* Sonsuz akÄ±ÅŸ (IntersectionObserver) */
  const io = new IntersectionObserver((entries)=>{
    const e = entries[0];
    if(!e.isIntersecting) return;
    if(state.shown < state.filtered.length) renderNext();
  },{root:null,rootMargin:'1000px 0px 1000px 0px',threshold:0});
  io.observe(sentinel);

  /* BaÅŸlat */
  buildSelectors(); loadAll();

  window.TabirlyMedia={state,resetAndRender,loadAll};
  </script>
</body>
</html>
