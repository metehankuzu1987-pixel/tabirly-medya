<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Tabirly Medya Kütüphanesi</title>
  <meta name="description" content="Tabirly için blog, podcast, video ve müzik RSS/Atom/JSON feed içeriklerini tek ekranda toplayan medya kütüphanesi." />
  <style>
    :root{
      --bg:#f7f8ff; --paper:#fff; --ink:#0e1320; --muted:#5e6a86;
      --line:rgba(99,110,140,.18); --br:14px; --shadow:0 6px 20px rgba(14,19,32,.06);
      --grad:linear-gradient(90deg,#ff0080,#ff8c00,#ffd700,#00d084,#00bfff,#7b61ff,#ff0080);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif}
    .tm-sr-only{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}

    /* Üst bar */
    #tm-app{position:fixed;inset:0;display:flex;flex-direction:column;gap:10px;padding:12px}
    .tm-top{display:flex;align-items:center;gap:10px;flex-wrap:wrap;padding:10px;border:1px solid var(--line);
            border-radius:var(--br);background:var(--paper);box-shadow:var(--shadow)}
    .tm-brand{display:flex;align-items:center;gap:8px;min-width:0}
    .tm-logo{width:24px;height:24px;border-radius:7px;background:var(--grad)}
    .tm-title{font:800 14px/1 Inter,system-ui;white-space:nowrap}
    .tm-grow{flex:1;min-width:160px}
    .tm-ctl{display:flex;gap:6px;align-items:center}
    select,input[type="text"]{appearance:none;border:1px solid var(--line);border-radius:10px;padding:8px 10px;background:#f9faff;color:var(--ink);font-weight:700}
    select{min-width:140px}
    .tm-search{display:flex;gap:8px;align-items:center}
    .tm-search input{width:min(420px,60vw)}
    .tm-counts{margin-left:auto;color:var(--muted);font-size:12px}

    /* Grid – tek tip kart */
    .tm-grid{flex:1;min-height:0;display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    @media (max-width:1400px){.tm-grid{grid-template-columns:repeat(10,1fr)}}
    @media (max-width:1024px){.tm-grid{grid-template-columns:repeat(8,1fr)}}
    @media (max-width:820px){.tm-grid{grid-template-columns:repeat(6,1fr)}}
    @media (max-width:640px){.tm-grid{grid-template-columns:repeat(2,1fr)}}

    .tm-card{
      grid-column:span 2; /* daha sıkı görünüm */
      display:flex;flex-direction:column;height:100%;
      border:1px solid var(--line);border-radius:12px;overflow:hidden;background:var(--paper);box-shadow:var(--shadow)
    }
    /* görsel (sabit görünüm) */
    .tm-thumb{position:relative;width:100%;aspect-ratio:16/9;background:#eef1f8;overflow:hidden}
    .tm-thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    /* logo fallback: TAM görünüm */
    .tm-thumb.fallback{background:#f6edf7}
    .tm-thumb.fallback img{object-fit:contain;padding:14px}

    .tm-card h3{font-size:13px;margin:8px 10px 4px}
    .tm-meta{color:var(--muted);font-size:11px;margin:0 10px 8px}
    /* intro kaldırıldı */
    .tm-desc{display:none}

    .tm-actions{display:flex;gap:6px;padding:8px 10px;border-top:1px solid var(--line);margin-top:auto}
    .tm-btn{appearance:none;border:1px solid var(--line);background:#f1f4ff;color:#192038;padding:6px 8px;border-radius:8px;font:700 11px/1 Inter;cursor:pointer}
    .tm-btn.primary{border-color:transparent;color:#fff;background:var(--grad)}
    /* Kart/“chip” karışıklığını kesin bitirmek için alan seçici */
    .tm-grid > .tm-card{display:flex}
    /* Modal */
    .tm-modal{position:fixed;inset:0;background:rgba(15,19,32,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .tm-modal.open{display:flex}
    .tm-sheet{width:min(1100px,96vw);height:min(80vh,80vh);background:var(--paper);border:1px solid var(--line);border-radius:14px;overflow:hidden;display:grid;grid-template-rows:auto 1fr;box-shadow:var(--shadow)}
    .tm-sheet header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
    .tm-sheet iframe,.tm-sheet audio,.tm-sheet video{width:100%;height:100%;border:0;background:#000}
  </style>
</head>
<body>
  <div id="tm-app">
    <div class="tm-top">
      <div class="tm-brand">
        <div class="tm-logo" aria-hidden="true"></div>
        <div class="tm-title">Tabirly Medya Kütüphanesi</div>
      </div>
      <div class="tm-ctl">
        <label class="tm-sr-only" for="tm-kind">Kategori</label>
        <select id="tm-kind" title="Kategori seç (Blog/Podcast/Video/Müzik)"></select>
      </div>
      <div class="tm-ctl">
        <label class="tm-sr-only" for="tm-source">Kaynak</label>
        <select id="tm-source" title="Kaynağa göre filtrele"></select>
      </div>
      <div class="tm-search tm-grow">
        <input id="tm-q" type="text" placeholder="Ara: başlık, açıklama, kaynak..." />
      </div>
      <div class="tm-counts"><span id="tm-feedCount">0</span> kaynak · <span id="tm-itemCount">0</span> içerik</div>
    </div>

    <div id="tm-grid" class="tm-grid"></div>
  </div>

  <div id="tm-playerModal" class="tm-modal" role="dialog" aria-modal="true">
    <div class="tm-sheet">
      <header>
        <div id="tm-playerTitle">Oynatıcı</div>
        <button id="tm-closePlayer" class="tm-btn">Kapat ✖</button>
      </header>
      <div id="tm-playerBody"></div>
    </div>
  </div>

  <script>
  /* ===== CONFIG ===== */
  // Yerleşik (inline) logo — “tam görünüm” (fallback)
  const LOGO_URL = 'data:image/svg+xml;utf8,\
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 288">\
    <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="0">\
      <stop offset="0" stop-color="#ff0080"/><stop offset="0.2" stop-color="#ff8c00"/>\
      <stop offset="0.4" stop-color="#ffd700"/><stop offset="0.6" stop-color="#00d084"/>\
      <stop offset="0.8" stop-color="#00bfff"/><stop offset="1" stop-color="#7b61ff"/>\
    </linearGradient></defs>\
    <rect width="100%" height="100%" rx="24" fill="url(#g)"/>\
    <g fill="white" font-family="Inter,Arial" font-weight="800">\
      <text x="50%" y="56%" font-size="70" text-anchor="middle">Tabirly</text>\
    </g>\
  </svg>';

  const CORS = 'https://little-paper-de94.metehankuzu1987.workers.dev';

  const FEEDS = [
    { title:'Tabirly', url:'https://tr.tabirly.com/feeds/posts/default?alt=rss', type:'blog' },
    { title:'Pazartesi Meditasyonları', url:'https://media.rss.com/pazartesimeditasyonu/feed.xml', type:'podcast' },
    { title:'Miboso x Dr. Neslihan İskit (Rehberli Meditasyon)', url:'https://media.rss.com/mibosowellbeing/feed.xml', type:'podcast' },
    { title:'Yoga Nidra Podcast', url:'https://anchor.fm/s/d3781a94/podcast/rss', type:'podcast' }
  ];

  const TYPES = [
    {key:'all', label:'Hepsi'},
    {key:'blog', label:'Blog'},
    {key:'podcast', label:'Podcast'},
    {key:'video', label:'Video'},
    {key:'music', label:'Müzik'}
  ];

  /* ===== STATE / REFS ===== */
  const $=(s,r=document)=>r.querySelector(s);
  const grid=$('#tm-grid'), q=$('#tm-q'), playerModal=$('#tm-playerModal'),
        playerBody=$('#tm-playerBody'), playerTitle=$('#tm-playerTitle'),
        selKind=$('#tm-kind'), selSource=$('#tm-source');
  let state={items:[],feeds:FEEDS,kind:'all',source:'all',q:''};

  const setCounts=()=>{$('#tm-feedCount').textContent=state.feeds.length; $('#tm-itemCount').textContent=filteredItems().length;};
  const humanDate=d=>{ try{return new Date(d).toLocaleString('tr-TR')}catch(e){return''} };
  const strip=html=>{ if(!html) return ''; const t=document.createElement('div'); t.innerHTML=html; return (t.textContent||'').trim().slice(0,240); };

  function buildSelectors(){
    selKind.innerHTML = TYPES.map(t=>`<option value="${t.key}">${t.label}</option>`).join('');
    selKind.value = state.kind;
    const options = ['<option value="all">Tüm kaynaklar</option>'].concat(
      state.feeds.map((f,i)=>`<option value="${i}">${f.title||('Kaynak '+(i+1))}</option>`)
    );
    selSource.innerHTML = options.join(''); selSource.value = state.source;
  }

  const primaryLabel=(it)=>{
    if(it.kind==='podcast' || it.kind==='music') return '▶ Dinle';
    if(it.kind==='video') return '▶ İzle';
    return '📖 Oku';
  };

  function cardHTML(it){
    const hasImg = Boolean(it.image);
    const imgSrc = hasImg ? it.image : LOGO_URL; // sabit fallback logo
    const safeTitle=(it.title||'İçerik').replace(/"/g,'&quot;');
    return `<article class="tm-card" data-id="${it._id}" data-kind="${it.kind}">
      <div class="tm-thumb ${hasImg ? '' : 'fallback'}">
        <img src="${imgSrc}" alt="${safeTitle}" loading="lazy"
             onerror="this.src='${LOGO_URL}'; this.closest('.tm-thumb').classList.add('fallback');">
      </div>
      <h3 title="${safeTitle}">${it.title||'Başlıksız'}</h3>
      <div class="tm-meta">${it.source||''}</div>
      <div class="tm-actions">
        <button class="tm-btn primary tm-play">${primaryLabel(it)}</button>
      </div>
    </article>`;
  }

  function filteredItems(){
    const qv = state.q.toLowerCase();
    return state.items.filter(it=>{
      if(state.kind!=='all' && it.kind!==state.kind) return false;
      if(state.source!=='all' && it._sourceIndex!==Number(state.source)) return false;
      if(!qv) return true;
      return [it.title,it.summary,it.source].filter(Boolean).join(' ').toLowerCase().includes(qv);
    });
  }

  function render(){
    const list = filteredItems();
    grid.innerHTML = list.map(cardHTML).join('');
    setCounts();
  }

  function openPlayer(it){
    playerTitle.textContent = it.title || 'Oynatıcı';
    playerBody.innerHTML = '';
    if(it.audio){
      const a=document.createElement('audio'); a.controls=true; a.src=it.audio; a.autoplay=true; playerBody.appendChild(a);
    }else if(it.videoEmbed){
      const f=document.createElement('iframe'); f.allow='autoplay; encrypted-media; picture-in-picture'; f.referrerPolicy='no-referrer-when-downgrade'; f.src=it.videoEmbed; playerBody.appendChild(f);
    }else if(it.link){
      const f=document.createElement('iframe'); f.src=it.link; playerBody.appendChild(f);
    }else{
      playerBody.innerHTML='<div style="padding:16px">Görüntülenecek medya bulunamadı.</div>';
    }
    playerModal.classList.add('open');
  }
  $('#tm-closePlayer').onclick=()=>playerModal.classList.remove('open');

  let t; q.oninput=()=>{ clearTimeout(t); t=setTimeout(()=>{ state.q=q.value; render(); },120); };
  selKind.onchange=()=>{ state.kind=selKind.value; render(); };
  selSource.onchange=()=>{ state.source=selSource.value; render(); };

  grid.addEventListener('click',e=>{
    const card=e.target.closest('.tm-card'); if(!card) return;
    const it = state.items.find(x=>String(x._id)===card.dataset.id);
    if(!it) return;
    if(e.target.classList.contains('tm-play')) openPlayer(it);
  });

  /* ===== FETCH/PARSE ===== */
  async function fetchText(url){
    const tryFetch=async(u)=>{const r=await fetch(u,{cache:'no-store'}); return {ok:r.ok, ct:r.headers.get('content-type')||'', text:await r.text()}}
    try{
      const r=await tryFetch(`${CORS}/?url=${encodeURIComponent(url)}`); if(r.ok) return r;
      return await tryFetch(url);
    }catch{ return await tryFetch(url); }
  }
  const textContent=(n,s)=>{const el=n.querySelector(s);return el?(el.textContent||'').trim():''};
  const attr=(n,s,a)=>{const el=n.querySelector(s);return el?el.getAttribute(a):''};

  function parseXML(xmlStr){
    const doc=new DOMParser().parseFromString(xmlStr,'application/xml');
    const isAtom=!!doc.querySelector('feed > entry');
    const channelTitle=textContent(doc,isAtom?'feed > title':'channel > title');
    const chanImg = attr(doc,'channel > image > url','') || textContent(doc,'channel > image > url');

    const items=Array.from(doc.querySelectorAll(isAtom?'feed > entry':'channel > item')).map(it=>{
      const title=textContent(it,'title');
      const link=isAtom?(attr(it,'link','href')||textContent(it,'link')):textContent(it,'link');
      const pub=textContent(it,isAtom?'updated':'pubDate') || textContent(it,'dc\\:date');
      const desc=textContent(it,isAtom?'summary':'description') || textContent(it,'content\\:encoded');

      const enc=it.querySelector('enclosure');
      const mediaContent=it.querySelector('media\\:content');
      const mediaThumb=it.querySelector('media\\:thumbnail');
      const itunesImg=attr(it,'itunes\\:image','href');
      const img = (mediaThumb&&mediaThumb.getAttribute('url')) ||
                  (mediaContent&&mediaContent.getAttribute('url')) ||
                  itunesImg || chanImg || '';

      let videoEmbed='';
      if(link && /youtube\.com\/watch|youtu\.be/.test(link)){
        const id=(link.match(/[?&]v=([\w-]+)/)||[])[1]||link.split('/').pop();
        videoEmbed=`https://www.youtube.com/embed/${id}`;
      }
      const audio=(enc && /audio\//.test(enc.getAttribute('type')||'')) ? enc.getAttribute('url') : '';

      return {title,link,date:pub,summary:strip(desc),image:img||'',audio,videoEmbed,source:channelTitle};
    });
    return items;
  }

  function parseJSONFeed(text){
    const j=JSON.parse(text); const title=j.title||'Kaynak';
    return (j.items||[]).map(it=>({
      title:it.title,
      link:it.url||(it.external_url||''),
      date:it.date_published||it.date_modified,
      summary:strip(it.summary||it.content_text||it.content_html||''),
      image:it.image||((it.attachments||[])[0]?.url)||'',
      audio:(it.attachments||[]).find(a=>(a.mime_type||'').startsWith('audio/'))?.url||'',
      source:title
    }));
  }

  const detectKind=(t,i)=> (t==='podcast'||i.audio)?'podcast' : (t==='music')?'music' : (t==='video'||i.videoEmbed)?'video' : 'blog';

  async function loadOne(feed,index){
    try{
      const {ct,text}=await fetchText(feed.url);
      let raw=[];
      if(/json|javascript/.test(ct)||text.trim().startsWith('{')) raw=parseJSONFeed(text); else raw=parseXML(text);
      return raw.map(it=>({...it,kind:detectKind(feed.type,it),_sourceIndex:index}));
    }catch(err){
      console.warn('Feed hatası',feed.url,err);
      return [{title:'Kaynak okunamadı',summary:'TypeError: Failed to fetch — CORS proxy gerekli olabilir.',link:feed.url,kind:'blog',source:feed.title,_sourceIndex:index}];
    }
  }

  function dedupeByLink(arr){
    const seen=new Set();
    return arr.filter(x=>{
      const k=(x.link||x.title||'') + '|' + (x.date?new Date(x.date).toISOString():'');
      if(seen.has(k)) return false; seen.add(k); return true;
    });
  }

  async function loadAll(){
    $('#tm-itemCount').textContent='…';
    const arrays=await Promise.all(state.feeds.map((f,i)=>loadOne(f,i)));
    let items=arrays.flat().map(it=>({...it,date:it.date?new Date(it.date):null}));
    items = dedupeByLink(items).sort((a,b)=> (b.date?.getTime()||0)-(a.date?.getTime()||0));

    state.items = items.map((it,idx)=>({
      ...it,
      _id: String(idx),
      image: (it.image && /^https?:/i.test(it.image)) ? it.image : '' // bozuk/relative ise boş (logo düşer)
    }));
    buildSelectors(); render();
  }

  buildSelectors(); loadAll();
  window.TabirlyMedia={state,render,loadAll};
  </script>
</body>
</html>
